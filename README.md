# DMParser üìú‚ú®

Welcome to **DMParser** ‚Äì a powerful and flexible Rust tool designed to parse and process CSV files generated by Deal Machine with high performance and precision. This project leverages modern parsing techniques and asynchronous database operations to quickly ingest and process large CSV datasets.

---

## Features üöÄ

- **Advanced Parsing:** Efficiently parses complex DM CSV formats.
- **Customizable:** Easily extend and modify parsing and batch processing rules.
- **High Performance:** Utilizes asynchronous operations and bulk inserts to handle high volumes of data.
- **Robust:** Comprehensive error handling, duplicate checking, and configurable execution limits.
- **Developer-Friendly:** Clear code structure with detailed inline documentation.

---

## Requirements & Dependencies üõ†Ô∏è

- **Rust:** Latest stable version (tested with Rust 1.70+)
- **Database:** MySQL (with an active connection string)
- **Additional Dependencies:**
  - `anyhow`
  - `chrono`
  - `csv`
  - `dotenvy`
  - `lazy_static`
  - `regex`
  - `sqlx` (with MySQL feature enabled)
  - `glob`
  - `tokio` (for asynchronous runtime)

All dependencies are specified in your `Cargo.toml`.

---

## Setup & Installation

### 1. Clone the Repository

```bash
git clone https://github.com/saintpetejackboy/DMParser.git
cd DMParser
```

### 2. Set Up Environment Variables

Create a `.env` file in the root directory with the necessary configuration options. Below is an example:

```dotenv
# .env

# MySQL database connection string
DATABASE_URL=mysql://username:password@localhost:3306/dbname

# Directories for processing
UPLOAD_DIR=./uploads
PROCESSED_DIR=./processed

# Lock file used to prevent concurrent processing
LOCK_FILE=./process.lock

# Batch insert size for the CSV processing
BATCH_SIZE=1000

# Maximum execution seconds per file before timeout
MAX_EXECUTION_SECONDS=3600
```

> **Note:** Replace `username`, `password`, `localhost`, `3306`, and `dbname` with your actual database configuration.

### 3. Build the Project

Compile the project using Cargo:

```bash
cargo build --release
```

### 4. Run the Application

Execute the compiled binary from the command line and provide the path to your CSV file (inside the configured `UPLOAD_DIR`). For example:

```bash
cargo run --release -- --input uploads/your_csv_file.csv
```

> **Tip:** You can always use the `--help` flag to see additional options:
>
> ```bash
> cargo run --release -- --help
> ```

---

## How It Works

- **Environment Setup:**  
  The application loads configuration options from the `.env` file to setup database connections and processing directories.

- **Lock Mechanism:**  
  A lock file is created upon startup to prevent multiple instances from running concurrently. This file is automatically removed when the process exits.

- **CSV Processing:**  
  The program scans the upload directory for CSV files matching a specific filename pattern. It validates and then processes each record in batches. Duplicate entries (based on `lead_id`) are skipped using an in-memory cache, and only new records are inserted.

- **Database Transactions:**  
  Bulk inserts are used for both address and phone queue records inside a single transaction to ensure data consistency and speed.

- **Campaign Management:**  
  The application checks if the corresponding campaign exists in the database, creating a new one if necessary, and retrieves the campaign flag to mark processed records.

---

## Contributing ü§ù

Contributions are welcome! If you have ideas or improvements, please:

1. Fork the repository.
2. Create a feature branch:
   ```bash
   git checkout -b feature/your-feature-name
   ```
3. Commit your changes with a clear description:
   ```bash
   git commit -am 'Add feature X'
   ```
4. Push to the branch:
   ```bash
   git push origin feature/your-feature-name
   ```
5. Open a pull request against the main branch.

---

## License üìÑ

This project is currently unlicensed. If you plan to reuse or distribute this code, please contact the project maintainers for clarification.

